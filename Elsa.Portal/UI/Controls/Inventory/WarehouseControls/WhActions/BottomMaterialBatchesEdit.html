<div id="batchesEdit">
    
    <button event-bind="click:createNewBatch" class="addBatchBut"><i class="fas fa-plus"></i></button>

    <div id="batchesList">

        <div id="batchTemplate">
            <div class="batchViewPanel" data-bind="class.hidden:editMode">
                <div class="batchViewRow stackLeft">
                    <div class="batchDt" data-bind="text:DisplayDt"></div>
                    <div class="batchNumber" data-bind="text:BatchNumber"></div>
                    <div class="batchVolume mergeRight" data-bind="text:Volume"></div>
                    <div class="batchUnit noSpace mergeRight" data-bind="text:UnitName"></div>
                    <div class="batchMaterial" data-bind="text:MaterialName"></div>
                    <div class="batchActions">
                        <i class="fas fa-edit faButton" event-bind="click:editBatch(Id)"></i>
                    </div>
                </div>
                
            </div>
            <div class="batchEditPanel form" data-bind="class!.hidden:editMode">
                <div class="batchEditUi">
                    
                    <!-- Material -->
                    <div class="formRow">
                        <label>Materiál</label>
                        <div class="inputGroup">
                            <div class="autocomplete" lt-name="materialAutocompleteContainer">
                                <input lt-name="material" required="required" data-bind="value:MaterialName" event-bind="change:onMaterialChanged(this, $unit, $batchNr, $amount); " />
                            </div>
                        </div>
                    </div>

                    <!-- Batch Nr -->
                    <div class="formRow">
                        <label>Číslo šarže</label>
                        <div class="inputGroup">
                            <input lt-name="batchNr" class="tbBatchNr" required="required" data-bind="value:BatchNumber"/>
                        </div>
                    </div>
                    
                    <div class="amountContainer formRow">
                        <label>Množství</label>
                        
                        <div class="stackLeft">
                            <input lt-name="amount" class="hasUnit" type="number" required="required" data-bind="value:Volume" />
                            <div class="autocomplete" lt-name="materialUnitAutocompleteContainer">
                                <input lt-name="unit" required="required" class="unitInput" data-bind="value:UnitName" />
                            </div>
                        </div>
                    </div>

                    <!-- Date -->
                    <div class="formRow" data-bind="class.hidden:hideDate">
                        <label>Datum</label>
                        <div class="inputGroup">
                            <input lt-name="dt" data-bind="value:DisplayDt"/>
                        </div>
                    </div>
                    
                    <!-- Invoice -->
                    <div class="formRow">
                        <label>Číslo faktury</label>
                        <div class="inputGroup">
                            <input lt-name="invoiceNr" data-bind="value:InvoiceNumber" />
                        </div>
                    </div>

                    <!-- Price -->
                    <div class="formRow">
                        <label>Cena</label>
                        <div class="inputGroup stackLeft">
                            <input lt-name="price" type="number" required="required" data-bind="value:Price"/>
                            <div class="currencyLbl">CZK</div>
                        </div>
                    </div>

                </div>
                <div class="batchesEditButtons formActions">
                    <i class="far fa-trash-alt faButton"></i>
                    <button class="butCancel" event-bind="click:cancelBatchEdit"></button>
                    <button class="butSubmit" event-bind="click:saveEdit(VM, $batchNr.value, $material.value, $amount.value, $unit.value, $dt.value, $price.value, $invoiceNr.value)"></button>
                    
                </div>
            </div>
        </div>

    </div>

    <button event-bind="click:loadOlderBatches" id="loadOlderBatches" data-bind="class!.hidden:canLoadOlderBottomMaterialBatches">Starší</button>
</div>


<script>
    lt.element("batchesEdit").withModel("app.warehouseActions.vm").attach(function(batchesList, batchTemplate) {
        
        var batchItemController = function (materialAutocompleteContainer, materialUnitAutocompleteContainer, material) {
            
            var setupAutosuggest = function() {
                app.ui.autosuggest(materialAutocompleteContainer, app.warehouseActions.vm.searchMaterialNames);
                app.ui.autosuggest(materialUnitAutocompleteContainer,
                    app.warehouseActions.vm.searchMaterialUnits,
                    function() {
                        return material.value;
                    });
            };

            setTimeout(setupAutosuggest, 0);

            this.bind(function(editMode) {
                if (editMode) {
                    setTimeout(function() { material.focus(); }, 0);
                }
            });
        };


        this.bind(function(bottomMaterialBatches) {

            lt.generate(batchesList, batchTemplate, bottomMaterialBatches, function(b) { return b.Id; }, batchItemController);

        });

        this.editBatch = function(batchId) {
            app.warehouseActions.vm.setBottomMaterialBatchEditMode(batchId);
        };

        this.cancelBatchEdit = function() {
            app.warehouseActions.vm.setBottomMaterialBatchEditMode(null);
        };

        this.createNewBatch = function() {
            app.warehouseActions.vm.createBottomMaterialBatch();
        };

        var isEmpty = function(s) {
            return (!s || s.length < 1);
        };

        this.saveEdit = function(model, batchNr, material, amount, unit, dt, price, invoiceNr) {
            batchNr = batchNr || "";

            if (isEmpty(material)) {
                throw new Error("Název materiálu nesmí být prázdný");
            }

            if (isEmpty(amount)) {
                throw new Error("Množství nesmí být prázdné");
            }

            if (isEmpty(unit)) {
                throw new Error("Měrná jednotka musí být vyplněna");
            }

            model.BatchNumber = batchNr;
            model.MaterialName = material;
            model.Volume = parseFloat(amount);
            model.UnitName = unit;
            model.DisplayDt = dt;
            model.Price = parseFloat(price);
            model.InvoiceNumber = invoiceNr;

            app.warehouseActions.vm.saveBottomMaterialBatch(model);
        };

        this.onMaterialChanged = function(tbMaterial, tbUnit, tbBatchNr, tbAmount) {
            app.materialHelper.autofill(tbMaterial, tbUnit, tbBatchNr, function() {
                if ((tbBatchNr.value || "").length === 0) {
                    setTimeout(function() { tbBatchNr.focus(); });
                } else {
                    setTimeout(function () { tbAmount.focus(); });
                }
            });
        };

        this.loadOlderBatches = function() {
            app.warehouseActions.vm.loadBottomMaterialBatches();
        };
    });
</script>
<link href="/UI/Controls/Inventory/WarehouseControls/WhActions/BottomMaterialBatchesStyle.css" rel="stylesheet" />