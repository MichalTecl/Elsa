<div id="batchEdit" class="productionBatchEdit">
    <div id="main">
        <div id="prodBatchFlagsContainer">
            <i id="butLock" class="fas fa-lock faButton" data-bind="class.batchLockActive:IsLocked" event-bind="click:onLockClick()"></i>
            <i class="lblLock"  data-bind="class!.hidden:IsLocked">Odemknout šarži</i>
            <i class="lblUnlock" data-bind="class.hidden:IsLocked">Zamknout šarži</i>
        </div>
        <div id="prodBatchHead">

            <div id="materialSelectorContainer" class="autocomplete">
                <label for="tbMaterial">Materiál</label>
                <input id="tbMaterial" type="text" data-bind="value:MaterialName" required="required" event-bind="change:onHeadChanged(this); keyup:onHeadChanged(this)"/>
            </div>
            <div id="amountContainer">
                <label for="tbAmount">Množství</label>
                <input type="number" step="0.01" id="tbAmount" data-bind="value:ProducedAmount" required="required" event-bind="change:onHeadChanged; keyup:onHeadChanged"/>
            </div>
            <div class="autocomplete" id="unitSelectorContainer">
                <input id="tbUnit" data-bind="value:ProducedAmountUnitSymbol" required="required" event-bind="change:onHeadChanged; keyup:onHeadChanged"/>
            </div>
            <div id="batchNrContainer">
                <label for="tbBatchNr">Číslo šarže</label>
                <input id="tbBatchNr" data-bind="value:BatchNumber" required="required" event-bind="change:onHeadChanged; keyup:onHeadChanged"/>
            </div>
            <div id="batchHeadChangesButtonsContainer" class="stackLeft">
                <button event-bind="click:saveHeadChanges">ok</button>
            </div>
        </div>

        <div id="prodBatchComponentsContainer">
            <div id="componentsList">
                <div id="componentListItemTemplate" class="lt-template">
                    <div class="stackLeft">
                        <div class="stackLeft">
                            <div data-bind="text:RequiredAmount"></div>
                            <div data-bind="text:RequiredAmountUnitSymbol"></div>
                            <div data-bind="text:MaterialName"></div>
                        </div>
                        <div lt-name="assignedBatchesList">
                            <div lt-name="assignedBatchItemTemplate" class="lt-template">
                                <div lt-name="assignedBatchView" class="stackLeft" data-bind="class.disabled:isDisabled" event-bind="keydown:onAssignmentKeyDown(VM, event, $tbAsgAmount.value, $tbAsgUnit.value, $tbAsgBatch.value)">
                                    <input lt-name="tbAsgAmount" data-bind="value:UsedAmount" type="number" step="0.01" event-bind="change:onAssignmentChanged(assignmentIndex, $tbAsgAmount.value, $tbAsgUnit.value, $tbAsgBatch.value);keyup:onAssignmentChanged(assignmentIndex, $tbAsgAmount.value, $tbAsgUnit.value, $tbAsgBatch.value)"/>
                                    <input lt-name="tbAsgUnit" data-bind="value:UsedAmountUnitSymbol" event-bind="change:onAssignmentChanged(assignmentIndex, $tbAsgAmount.value, $tbAsgUnit.value, $tbAsgBatch.value); keyup:onAssignmentChanged(assignmentIndex, $tbAsgAmount.value, $tbAsgUnit.value, $tbAsgBatch.value)"/>
                                    <input lt-name="tbAsgBatch" data-bind="value:UsedBatchNumber" event-bind="change:onAssignmentChanged(assignmentIndex, $tbAsgAmount.value, $tbAsgUnit.value, $tbAsgBatch.value); keyup:onAssignmentChanged(assignmentIndex, $tbAsgAmount.value, $tbAsgUnit.value, $tbAsgBatch.value)"/>
                                    <i class="fas fa-minus faButton" event-bind="click:onRemoveBatchAssignmentClick(VM)"></i>

                                    <div class="assignmentButtons stackLeft" data-bind="class!.hidden:isDirty">
                                        <i class="fas fa-undo faButton" event-bind="click:undoAssignmentChanges(assignmentIndex, $tbAsgAmount, $tbAsgUnit, $tbAsgBatch)"></i>
                                        <i class="far fa-check-circle faButton" data-bind="class!.hidden:isValid" event-bind="click:saveAssignmentChanges(assignmentIndex, $tbAsgAmount.value, $tbAsgUnit.value, $tbAsgBatch.value)"></i>
                                    </div>

                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    lt.element("batchEdit").withModel("app.production.vm.editBatch").attach(function (materialSelectorContainer, unitSelectorContainer, tbMaterial, tbAmount, tbUnit, tbBatchNr, batchHeadChangesButtonsContainer, componentsList, componentListItemTemplate, prodBatchComponentsContainer, prodBatchFlagsContainer) {

        var self = this;

        app.ui.autosuggest(materialSelectorContainer, app.warehouseActions.vm.searchMaterialNames);
        app.ui.autosuggest(unitSelectorContainer,
            app.warehouseActions.vm.searchMaterialUnits,
            function () {
                return tbMaterial.value;
            });

        var valField = function(field) {
            
            if (field.value === null || field.value.length < 1) {
                return false;
            }

            return true;
        }

        this.bind(function(isHeadEdit) {

            if (isHeadEdit) {
                batchHeadChangesButtonsContainer.style.display = 'flex';
                prodBatchComponentsContainer.style.display = 'none';
            } else {
                batchHeadChangesButtonsContainer.style.display = 'none';
                prodBatchComponentsContainer.style.display = 'block';
            }
        });

        this.onHeadChanged = function (sourceElement) {

            if (sourceElement === tbMaterial) {

                tbUnit.value = "";

                app.materialHelper.autofill(tbMaterial,
                    tbUnit,
                    tbBatchNr,
                    function() {
                        app.production.vm.checkHeadChanged(tbMaterial.value,
                            tbAmount.value,
                            tbUnit.value,
                            tbBatchNr.value);

                        if (tbUnit.value) {
                            setTimeout(tbAmount.focus(), 0);
                        }
                    });
            } else {
                app.production.vm.checkHeadChanged(tbMaterial.value,
                            tbAmount.value,
                            tbUnit.value,
                            tbBatchNr.value);
            }
        };

        this.saveHeadChanges = function() {
            app.production.vm.setBatchHead(tbMaterial.value, tbBatchNr.value, tbAmount.value, tbUnit.value);
        };


        var componentController = function(assignedBatchesList, assignedBatchItemTemplate) {
            
            this.bind(function (Assignments) {
                lt.generate(assignedBatchesList, assignedBatchItemTemplate, Assignments, function (a) { return a.AssignmentUid; }, function(tbAsgBatch) {
                    this.bind(function(toBeResolved) {
                        if (toBeResolved) {
                            setTimeout(function() { tbAsgBatch.focus(); }, 10);
                        }
                    });
                });
            });

            this.onRemoveBatchAssignmentClick = function(model) {
                app.production.vm.removeAssignment(model.assignmentIndex);
            };
        };

        this.bind(function(BatchId) {
            if (!BatchId) {
                prodBatchFlagsContainer.style.display = 'none';
            } else {
                prodBatchFlagsContainer.style.display = 'block';
            }
        }).BatchIdCanBeNull();

        this.bind(function(Components) {
            lt.generate(componentsList, componentListItemTemplate, Components, function(c) { return c.MaterialId; }, componentController);
        });

        this.onAssignmentChanged = function (assignmentIndex, amount, unit, batchNr) {
            app.production.vm.checkAssignmentChanged(assignmentIndex, amount, unit, batchNr);
        };

        this.onAssignmentKeyDown = function(model, event, amount, unit, batchNr) {
            
            if (event.key !== "Enter") {
                return;
            }

            if ((!model.isValid) && (!model.isDirty)) {
                return;
            }

            app.production.vm.commitAssignmentChange(model.assignmentIndex, amount, unit, batchNr);
        };

        this.undoAssignmentChanges = function(assignmentIndex, tbAsgAmount, tbAsgUnit, tbAsgBatch) {
            var originalData = app.production.vm.getAssignmentByIndex(assignmentIndex);
            if (!originalData) {
                return;
            }

            tbAsgAmount.value = originalData.UsedAmount;
            tbAsgUnit.value = originalData.UsedAmountUnitSymbol;
            tbAsgBatch.value = originalData.UsedBatchNumber;

            self.onAssignmentChanged(assignmentIndex,
                originalData.UsedAmount,
                originalData.UsedAmountUnitSymbol,
                originalData.UsedBatchNumber);
        };

        this.saveAssignmentChanges = function (assignmentIndex, amount, unit, batch) {
            app.production.vm.commitAssignmentChange(assignmentIndex, amount, unit, batch);
        };

        this.onLockClick = function() {
            app.production.vm.toggleLock();
        }
    });

</script>