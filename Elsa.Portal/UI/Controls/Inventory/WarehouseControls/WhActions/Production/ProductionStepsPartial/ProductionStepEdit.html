<div id="prodStepEditUi">
    <div id="prStepHead">
        <div class="stepMaterial" data-bind="text:MaterialName"></div>
        <div class="stepName" data-bind="text:StepName"></div>
    </div>
    <div id="stepBatch" data-bind="class.hidden:IsAutoBatch">
        <div id="stepBatchVw">
            <div class="formRow">
                <label>Číslo šarže</label>
                <div data-bind="class!.hidden:NeedsBatchNumber" class="stackLeft">
                    <input id="tbBatchNr" event-bind="change:onBatchEnterClick($tbBatchNr.value)" />
                </div>
                <div id="staticBatchView" data-bind="text:BatchNumber; class.hidden:NeedsBatchNumber">?</div>
            </div>
            

            <div data-bind="class.hidden:NeedsBatchNumber">
                <div class="formRow">
                    <div id="stepQtyPanel">
                        <label>Zpracované množství</label>
                        <div class="stackLeft">
                            <input type="number" id="tbAmount" class="inputAmount" data-bind="value:Quantity; max:MaxQuantity" min="0" event-bind="change:updateStepQty($tbAmount.value)" />
                            <div data-bind="text:UnitSymbol"></div>
                        </div>
                    </div>
                </div>
                
                <div class="formRow" data-bind="class!.hidden:hasComponents">
                    <div id="stepMaterialsPanel">
                        
                        <label>Použitý materiál</label>
                        <div class="gridRow gridHead">
                            <div class="cell10">Materiál</div>
                            <div class="cell10">Množství</div>
                            <div class="cell10">Šarže</div>
                        </div>
                        <div data-bind="itemsSource:Materials" data-key="itemKey">
                            <div class="lt-template stepMaterialItem">
                                <div class="gridRow">
                                    <div class="cell10">
                                        <div data-bind="text:MaterialName" class="stepMaterialName"></div>
                                    </div>
                                    <div class="cell10 stackLeft">
                                        <div class="stackLeft">
                                            <input class="inputAmount" type="number" event-bind="change:updateComponent(VM, $tbBatch.value, $tbAmount.value)" lt-name="tbAmount" data-bind="value:Amount; class.readonly:AutomaticBatches" class="stepMaterialAmount" />
                                            <div data-bind="text:UnitSymbol" class="stepMaterialUnit"></div>
                                        </div>
                                    </div>
                                    <div class="cell10">
                                        <input lt-name="tbBatch" event-bind="change:updateComponent(VM, $tbBatch.value, $tbAmount.value)" data-bind="value:BatchNumber; class.hidden:AutomaticBatches" class="stepMaterialBatch" />
                                        <div class="unresolvableAutomaticBatch stackLeft" data-bind="class!.hidden:cannotResolve">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            <div>Není k dispzici dostatek materiálu ve skladu</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="stepWorkerPanel" data-bind="class!.hidden:RequiresWorkerReference" class="formRow">
                    <label>Pracovník</label>
                    <input id="tbWorker" data-bind="value:Worker" event-bind="change:onAdditionalFieldsUpdate($tbWorker.value, $tbTime.value, $tbPrice.value)"/>
                </div>
                <div id="stepTimePanel" data-bind="class!.hidden:RequiresTime" class="formRow">
                    <label>Počet hodin</label>
                    <input id="tbTime" data-bind="value:Hours" event-bind="change:onAdditionalFieldsUpdate($tbWorker.value, $tbTime.value, $tbPrice.value)"/>
                </div>
                <div id="stepPricePanel" data-bind="class!.hidden:RequiresPrice" class="formRow">
                    <label>Cena</label>
                    <input id="tbPrice" data-bind="value:Price" event-bind="change:onAdditionalFieldsUpdate($tbWorker.value, $tbTime.value, $tbPrice.value)"/>
                </div>
            </div>

            <div>
                <button class="butSync" data-bind="class.hidden:IsValid" event-bind="click:validateStep"><i class="fas fa-sync"></i></button>
                <button class="butSubmit" data-bind="class!.hidden:IsValid" event-bind="click:saveStep"></button>
                <button class="butCancel" event-bind="click:onCancelStepClick"></button>
            </div>
        </div>
    </div>
</div>

<script>
    lt.element("prodStepEditUi").withModel("app.productionSteps.vm.selectedStep").attach(function() {

        this.onBatchEnterClick = function (batchNr) {
            console.log(batchNr);
            app.productionSteps.vm.setBatchNumber(batchNr);
        };

        this.onCancelStepClick = function() {
            app.productionSteps.vm.cancelStepEdit();
        };

        this.updateStepQty = function(strQty) {
            var value = parseFloat(strQty);
            app.productionSteps.vm.updateQuantity(value);
        };

        this.updateComponent = function(model, batchNr, amount) {
            var numAmount = parseFloat(amount);

            app.productionSteps.vm.updateComponent(model.itemKey, batchNr, numAmount);
        };

        this.onAdditionalFieldsUpdate = function(worker, time, price) {
            app.productionSteps.vm.updateAdditionalFields(worker, time, price);

        };

        this.validateStep = function() {
            app.productionSteps.vm.doStepValidation();
        };

        this.saveStep = function() {
            app.productionSteps.vm.saveStep();
        };
    });

</script>