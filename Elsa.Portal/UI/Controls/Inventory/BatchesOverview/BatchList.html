<div id="batchList_{%GENERATE%}">
    <div lt-name="theList">
        <!--{"BatchId":101,"InventoryName":"Výrobky","BatchNumber":"1952001","MaterialName":"Krém Antipupínek 30ml","MaterialId":33,"BatchVolume":"100 ks",
        "AvailableAmount":"0 ks","CreateDt":"08.01.19 20:04","IsClosed":false,"IsLocked":false,"IsAvailable":false,"AllStepsDone":false,"NumberOfComponents":0,
        "NumberOfCompositions":0,"NumberOfRequiredSteps":1,"NumberOfOrders":0}-->

        <div class="lt-template bovRow" lt-name="batchReviewItemTemplate">
            <div class="bovRowData stackLeft">
                <div data-bind="text:BatchNumber"></div>
                <div data-bind="text:MaterialName"></div>
                <div data-bind="text:AvailableAmount"></div>
                <div data-bind="text:BatchVolume"></div>
                <div data-bind="text:CreateDt"></div>
            </div>
            <div class="bovRowDetail">
                <div class="bovLazyPanel" style="margin-left: 10px">
                    <div data-bind="class!.hidden:hasComponents" class="actionLink" data-queryProperty="CompositionId" lt-name="butLoadComponents" event-bind="click:loadSubs(BatchId, $componentsListPlaceholder, $butLoadComponents)">
                        <span>Skládá se z&nbsp;</span><span data-bind="text:NumberOfComponents"></span><span>&nbsp;šarží</span>
                    </div>
                    <div lt-name="componentsListPlaceholder"></div>
                </div>
                
                <div class="bovLazyPanel" style="margin-left: 10px">
                    <div data-bind="class!.hidden:hasCompositions" class="actionLink" data-queryProperty="ComponentId" lt-name="butLoadCompositions" event-bind="click:loadSubs(BatchId, $compostListPlaceholder, $butLoadCompositions)">
                        <span>Je použita v&nbsp;</span><span data-bind="text:NumberOfCompositions"></span><span>&nbsp;šarží</span>
                    </div>
                    <div lt-name="compostListPlaceholder"></div>
                </div>
                
                <div class="bovLazyPanel" style="margin-left: 10px" data-bind="class!.hidden:hasSteps">
                    <div class="actionLink" data-queryProperty="LoadSteps" lt-name="butLoadSteps" event-bind="click:update(VM, $butLoadSteps)" >Výrobní kroky</div>
                    <div class="lstProductionStepsContainer">
                        <div data-bind="itemsSource:Steps" data-key="MaterialStepId">
                            <div class="bovProdStepItem lt-template">
                                <div class="stackLeft bovStepRow">
                                    <div class="bovStepName" data-bind="text:StepName"></div>
                                    <div class="bovStepPercent" data-bind="text:DonePercent"></div>
                                    <div class="bovPerformedStepsPanel" data-bind="itemssource:PerformedSteps" data-key="StepId">
                                        <div class="bovPerStepItem lt-template">
                                            <div class="bovPerStepRow">
                                                <div class="bovPerStepDt" data-bind="text:ConfirmDt"></div>
                                                <div class="bovPerStepAmount" data-bind="text:Amount"></div>
                                                <div class="bovPerStepWorker" data-bind="text:Worker"></div>
                                                <div class="bovPerStepTime" data-bind="text:SpentHours"></div>
                                                <div class="bovPerStepPrice" data-bind="text:Price"></div>
                                                <div class="bovPerStepConfirmUser" data-bind="text:ConfirmUser"></div>
                                            </div>
                                            <div class="bovPerStepComponentsList" data-bind="itemssource:Components" data-key="StepBatchId">
                                                <div class="lt-template bovPerStepComponentItem">
                                                    <div class="bovPerStepCoAmount" data-bind="text:Amount"></div>
                                                    <div class="bovPerStepCoMaterial" data-bind="text:MaterialName"></div>
                                                    <div class="bovPerStepCoBatch" data-bind="text:BatchNumber"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

            </div>

        </div>

    </div>

    <button lt-name="btnMore" event-bind="click:loadMore">Načíst více</button>
</div>
<script src="/Script/Apps/Inventory/BatchOverview/BatchesOverviewVM.js"></script>
<script>
    lt.element("batchList_{%GENERATE%}").attach(function (theList, batchReviewItemTemplate, btnMore) {
        
        var self = this;

        var getSession = function() {
            var session = self["__session"];
            if (!session) {
                session = self["__session"] = { "list":[], "canLoadMore":false, "query":{} };
            }

            return session;
        };

        var updateView = function() {
            var session = getSession();
            lt.generate(theList, batchReviewItemTemplate, session.list, function (b) { return b.itemKey; });

            if (session.canLoadMore) {
                btnMore.style.display = 'block';
            } else {
                btnMore.style.display = 'none';
            }
        };

        self.setQuery = function(query) {
            var session = getSession();
            session.query = query;
            session.list.splice(0, session.list.length);
            session.canLoadMore = false;

            updateView();

            app.batchesOverview.vm.load(session, updateView);
        };

        self.loadMore = function () {
            var session = getSession();
            app.batchesOverview.vm.load(session, updateView);
        };

        var setQueryToPlaceholder = function(placeholder, query) {
            
            if (placeholder.setQuery) {
                placeholder.setQuery(query);
                return;
            }

            lt.replaceBy(placeholder, "/UI/Controls/Inventory/BatchesOverview/BatchList.html", function(ph) {
                ph.setQuery(query);
            });
        };
        
        self.loadSubs = function (bid, placeholder, caller) {

            var property = caller.getAttribute("data-queryProperty");

            var qry = { };
            qry[property] = bid;

            setQueryToPlaceholder(placeholder, qry);
        };

        self.update = function(batchModel, caller) {
            var property = caller.getAttribute("data-queryProperty");

            var qry = {"BatchId": batchModel.BatchId};
            qry[property] = true;

            app.batchesOverview.vm.loadSingleBatch(batchModel, qry);
        };
        
        updateView();
    });
</script>