<div id="batchList_{%GENERATE%}">
    <div class="gridRow gridHead">
        <div class="cell1"></div>
        <div lt-name="lblCustomField1" style="display:none" class="cell5"></div>
        <div lt-name="lblCustomField2" style="display:none" class="cell5"></div>
        <div lt-name="lblCustomField3" style="display:none" class="cell10"></div>
        <div class="cell10">Číslo šarže</div>
        <div class="cell10">Materiál</div>
        <div class="cell5">Dostupné</div>
        <div class="cell5">Celkem</div>
        <div class="cell10">Vytvořeno</div>
        <div class="cell5">Cena</div>
        <div class="cell10">Faktura</div>
        <div class="cell1"></div>
    </div>
    <div lt-name="theList">
        <!--{"BatchId":101,"InventoryName":"Výrobky","BatchNumber":"1952001","MaterialName":"Krém Antipupínek 30ml","MaterialId":33,"BatchVolume":"100 ks",
        "AvailableAmount":"0 ks","CreateDt":"08.01.19 20:04","IsClosed":false,"IsLocked":false,"IsAvailable":false,"AllStepsDone":false,"NumberOfComponents":0,
        "NumberOfCompositions":0,"NumberOfRequiredSteps":1,"NumberOfOrders":0}-->

        <div class="lt-template bovRow" lt-name="batchReviewItemTemplate" data-bind="class.expanded:expanded">

            <div class="bovRowData gridRow">
                <div class="cell1">
                    <div data-bind="class!.hidden:canExpand">
                        <i data-bind="class.hidden:expanded" class="far fa-plus-square faButton" event-bind="click:toggleExpansion(VM)"></i>
                        <i data-bind="class!.hidden:expanded" class="far fa-minus-square faButton" event-bind="click:toggleExpansion(VM)"></i>
                    </div>
                </div>
                <div data-bind="text:CustomField1; class!.hidden:showCustomField1" class="cell5"></div>
                <div data-bind="text:CustomField2; class!.hidden:showCustomField2" class="cell5"></div>
                <div data-bind="text:CustomField3; class!.hidden:showCustomField3" class="cell10"></div>
                <div data-bind="text:BatchNumber" class="bovBatchNumber cell10"></div>
                <div data-bind="text:MaterialName" class="bovBatchMaterial cell10"></div>
                <div data-bind="text:AvailableAmount" class="bovBatchAmount cell5"></div>
                <div data-bind="text:BatchVolume" class="bovBatchAmount cell5"></div>
                <div data-bind="text:CreateDt" class="bovBatchDt cell10"></div>
                <div data-bind="text:Price" class="cell5"></div>
                <div data-bind="text:InvoiceNumber" class="cell10"></div>
                <div class="cell1">
                    <i data-bind="class!.hidden:CanDelete" class="far fa-trash-alt faButton" event-bind="click:deleteBatch(VM)"></i>
                    <i class="far fa-trash-alt" style="opacity: 0.2; cursor:no-drop" data-bind="class.hidden:CanDelete;title:NoDelReason" ></i>
                </div>
            </div>
            <div class="bovRowDetail">
                <div class="bovLazyPanel bovBatchComponents">
                    <div data-bind="class!.hidden:hasComponents"
                         data-queryProperty="CompositionId"
                         data-expandedFlag="componentsExpanded"
                         data-loadedFlag="componentsLoaded"
                         lt-name="butLoadComponents"
                         event-bind="click:toggleSub(VM, $componentsListPlaceholder, $butLoadComponents)">
                        <div class="bovLazPanelController">
                            <div class="subExpander">
                                <i data-bind="class.hidden:componentsExpanded" class="far fa-plus-square faButton" ></i>
                                <i data-bind="class!.hidden:componentsExpanded" class="far fa-minus-square faButton" ></i>
                            </div>
                            <span>Složení (</span><span data-bind="text:NumberOfComponents"></span><span>)</span>
                        </div>
                    </div>
                    <div data-bind="class!.hidden:componentsExpanded">
                        <div lt-name="componentsListPlaceholder"></div>
                    </div>
                </div>
                
                <div class="bovLazyPanel bovBatchCompos">
                    <div data-bind="class!.hidden:hasCompositions"
                         data-queryProperty="ComponentId"
                         data-expandedFlag="composExpanded"
                         data-loadedFlag="composLoaded"
                         lt-name="butLoadCompos"
                         event-bind="click:toggleSub(VM, $composListPlaceholder, $butLoadCompos)">
                        <div class="bovLazPanelController">
                            <div class="subExpander">
                                <i data-bind="class.hidden:composExpanded" class="far fa-plus-square faButton"></i>
                                <i data-bind="class!.hidden:composExpanded" class="far fa-minus-square faButton"></i>
                            </div>
                            <span>Spotřeba ve výrobě (</span><span data-bind="text:NumberOfCompositions"></span><span>)</span>
                        </div>
                    </div>
                    <div data-bind="class!.hidden:composExpanded">
                        <div lt-name="composListPlaceholder"></div>
                    </div>
                </div>
                
                <div class="bovLazyPanel bovBatchSteps">
                    <div data-bind="class!.hidden:hasSteps"
                         data-queryProperty="LoadSteps"
                         data-queryPropertyValue="true"
                         data-expandedFlag="stepsExpanded"
                         data-loadedFlag="stepsLoaded"
                         lt-name="butLoadSteps"
                         event-bind="click:toggleSub(VM, null, $butLoadSteps)">
                        <div class="bovLazPanelController">
                            <div class="subExpander">
                                <i data-bind="class.hidden:stepsExpanded" class="far fa-plus-square faButton"></i>
                                <i data-bind="class!.hidden:stepsExpanded" class="far fa-minus-square faButton"></i>
                            </div>
                            <span>Výrobní kroky (</span><span data-bind="text:NumberOfRequiredSteps"></span><span>)</span>
                        </div>
                    </div>

                    <div data-bind="class!.hidden:stepsExpanded">
                        <div class="lstProductionStepsContainer">
                            <div class="gridRow gridHead">
                                <div class="cell1"></div>
                                <div class="cell10">Krok</div>
                                <div class="cell10">Dokončeno</div>
                                <div class="cell1"></div>
                            </div>
                            <div data-bind="itemsSource:Steps" data-key="MaterialStepId">
                                <div class="bovProdStepItem lt-template">
                                    <div class="bovStepRow">
                                        <div class="gridRow">
                                            <div class="cell1">
                                                <i class="far fa-plus-square faButton" event-bind="click:toggleView(this, $pnlPerformed)"></i>
                                            </div>
                                            <div class="bovStepName cell10" data-bind="text:StepName"></div>
                                            <div class="bovStepPercent cell10" data-bind="text:DonePercent"></div>
                                            <div class="cell1">
                                                <i class="fas fa-plus-circle faButton" event-bind="click:resolveStep(VM)"></i>
                                            </div>
                                        </div>
                                        
                                        <div lt-name="pnlPerformed" class="pnlPerformed" style="display:none">
                                            <div class="gridRow gridHead">
                                                <div class="cell10">Provedeno</div>
                                                <div class="cell5">Množství</div>
                                                <div class="cell5">Pracovník</div>
                                                <div class="cell5">Hodiny</div>
                                                <div class="cell5">Cena</div>
                                                <div class="cell5">Převzal</div>
                                                <div class="cell1"></div>
                                            </div>
                                            <div class="bovPerformedStepsPanel" data-bind="itemssource:PerformedSteps" data-key="StepId">
                                                <div class="bovPerStepItem lt-template">
                                                    <div class="bovPerStepRow gridRow">
                                                        <div class="bovPerStepDt cell10" data-bind="text:ConfirmDt"></div>
                                                        <div class="bovPerStepAmount cell5" data-bind="text:Amount"></div>
                                                        <div class="bovPerStepWorker cell5" data-bind="text:Worker"></div>
                                                        <div class="bovPerStepTime cell5" data-bind="text:SpentHours"></div>
                                                        <div class="bovPerStepPrice cell5" data-bind="text:Price"></div>
                                                        <div class="bovPerStepConfirmUser cell5" data-bind="text:ConfirmUser"></div>
                                                        <div class="cell1">
                                                            <i data-bind="class!.hidden:CanDelete" class="far fa-trash-alt faButton" event-bind="click:deleteProductionStep(VM)"></i>
                                                            <i class="far fa-trash-alt" style="opacity: 0.2; cursor:no-drop" data-bind="class.hidden:CanDelete" title="Již bylo použito množství vyprodukované tímto krokem, nebo následují další kroky"></i>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
     
                
                <div class="bovLazyPanel bovOrders">
                    <div data-bind="class!.hidden:hasOrders"
                         data-queryProperty="LoadOrdersPage"
                         data-queryPropertyValue="0"
                         data-expandedFlag="ordersExpanded"
                         data-loadedFlag="ordersLoaded"
                         lt-name="butLoadOrders"
                         event-bind="click:toggleSub(VM, null, $butLoadOrders)">
                        <div class="bovLazPanelController">
                            <div class="subExpander">
                                <i data-bind="class.hidden:ordersExpanded" class="far fa-plus-square faButton"></i>
                                <i data-bind="class!.hidden:ordersExpanded" class="far fa-minus-square faButton"></i>
                            </div>
                            <span>Spotřeba e-shop (</span><span data-bind="text:NumberOfOrders"></span><span>)</span>
                        </div>
                    </div>
                    <div class="bovOrders" data-bind="class!.hidden:ordersExpanded">
                        <div class="bovOrdersHead gridRow gridHead">
                            <div class="cell1"></div>
                            <div class="cell10">Číslo</div>
                            <div class="cell10">Zákazník</div>
                            <div class="cell10">Datum</div>
                            <div class="cell10">Stav</div>
                        </div>
                        <div data-bind="itemsSource:Orders" data-key="OrderId">
                            <div class="lt-template">
                                <div class="bovOrderRow gridRow">
                                    <div class="cell1">
                                        <i data-bind="class.hidden:BatchesExpanded" class="far fa-plus-square faButton" event-bind="click:toggleOrderBatches(VM, $orderBatchesPlaceHolder)"></i>
                                        <i data-bind="class!.hidden:BatchesExpanded" class="far fa-minus-square faButton" event-bind="click:toggleOrderBatches(VM)"></i>
                                    </div>
                                    <div class="cell10" data-bind="text:OrderNumber"></div>
                                    <div class="cell10" data-bind="text:Customer"></div>
                                    <div class="cell10" data-bind="text:PurchaseDate"></div>
                                    <div class="cell10" data-bind="text:Status"></div>
                                </div>
                                <div lt-name="orderBatchesPlaceHolder" data-bind="class!.hidden:BatchesExpanded"></div>
                            </div>
                        </div>
                        <button data-bind="class!.hidden:CanLoadMoreOrders" event-bind="click:loadMoreOrders(VM)">Více</button>
                    </div>
                </div>
            
            </div>
        </div>
    </div>

    <button lt-name="btnMore" event-bind="click:loadMore">Načíst více</button>
</div>
<script src="/Script/Apps/Inventory/BatchOverview/BatchesOverviewVM.js"></script>
<script>
    lt.element("batchList_{%GENERATE%}").attach(function (theList, batchReviewItemTemplate, btnMore, lblCustomField1, lblCustomField2, lblCustomField3) {
        
        var self = this;

        var getSession = function() {
            var session = self["__session"];
            if (!session) {
                session = self["__session"] = { "list":[], "canLoadMore":false, "query":{} };
            }

            return session;
        };

        var updateView = function() {
            var session = getSession();
            lt.generate(theList, batchReviewItemTemplate, session.list, function (b) { return b.itemKey; });

            if (session.canLoadMore) {
                btnMore.style.display = 'block';
            } else {
                btnMore.style.display = 'none';
            }

            if (session.showCustomField1) {
                lblCustomField1.innerHTML = session.customField1Name;
                lblCustomField1.style.display = 'block';
            }

            if (session.showCustomField2) {
                lblCustomField2.innerHTML = session.customField2Name;
                lblCustomField2.style.display = 'block';
            }

            if (session.showCustomField3) {
                lblCustomField3.innerHTML = session.customField3Name;
                lblCustomField3.style.display = 'block';
            }
        };

        self.setQuery = function(query) {
            var session = getSession();
            session.query = query;
            session.list.splice(0, session.list.length);
            session.canLoadMore = false;

            updateView();

            app.batchesOverview.vm.load(session, updateView);
        };

        self.loadMore = function () {
            var session = getSession();
            app.batchesOverview.vm.load(session, updateView);
        };

        var setQueryToPlaceholder = function(placeholder, query) {
            
            if (placeholder.setQuery) {
                placeholder.setQuery(query);
                return;
            }

            lt.replaceBy(placeholder, "/UI/Controls/Inventory/BatchesOverview/BatchList.html", function(ph) {
                ph.setQuery(query);
            });
        };
        
        self.toggleSub = function(model, list, caller) {
            var expandedFlag = caller.getAttribute("data-expandedFlag");
            model[expandedFlag] = !model[expandedFlag];

            var loadedFlag = caller.getAttribute("data-loadedFlag");

            if (!!model[loadedFlag]) {
                lt.notify(self);
                return;
            }

            model[loadedFlag] = true;

            var property = caller.getAttribute("data-queryProperty");

            var qry = {};
            var strValue = caller.getAttribute("data-queryPropertyValue");
            if (strValue == null) {
                qry[property] = model.BatchId;
            } else {

                qry[property] = strValue;

                if (strValue === "true") {
                    qry[property] = true;
                }
                var numValue = parseInt(strValue, 10);
                if (!isNaN(numValue)) {
                    qry[property] = numValue;
                }
            }

            if (!!list) {
                setQueryToPlaceholder(list, qry);
            }
            else {
                qry.BatchId = model.BatchId;
                app.batchesOverview.vm.loadSingleBatch(model, qry);
            }
        };

        self.update = function(batchModel, caller) {
           
        };

        self.toggleExpansion = function(model) {
            model.expanded = !model.expanded;
            lt.notify(self);
        };

        self.toggleView = function(button, panel) {
            if (panel.style.display === "none") {
                panel.style.display = 'block';
                button.setAttribute("class", "far fa-minus-square faButton");
            } else {
                panel.style.display = 'none';
                button.setAttribute("class", "far fa-plus-square faButton");
            }
        };

        self.loadMoreOrders = function (model) {
            var qry = { "BatchId": model.BatchId, "LoadOrdersPage": model.NextOrdersPage };
            app.batchesOverview.vm.loadSingleBatch(model, qry);
        };

        self.toggleOrderBatches = function(orderModel, batchListPlaceholder) {
            
            if (batchListPlaceholder == null || (!!orderModel.BatchesExpanded)) {
                orderModel.BatchesExpanded = false;
                lt.notify(self);
                return;
            }

            orderModel.BatchesExpanded = true;
            
            if (batchListPlaceholder["__batchListLoaded"]) {
                lt.notify(self);
                return;
            }

            batchListPlaceholder["__batchListLoaded"] = true;

            lt.fillBy(batchListPlaceholder, "/UI/Controls/Inventory/BatchesOverview/BatchList.html", function(blst) {
                blst.children[0].setQuery({ "RelativeToOrderId": orderModel.OrderId });
            });

        };

        self.refreshBatchView = function (depth) {
            
            var parent = self;
            while ((parent != null) && ((parent = parent.parentElement) != null)) {
                if (parent["refreshBatchView"]) {
                    parent.refreshBatchView(depth - 1);
                    return;
                }
            } 
            
            var session = getSession();
            session.query.PageNumber = 0;
            self.setQuery(JSON.parse(JSON.stringify(session.query)));
        };

        self.deleteBatch = function (model) {
            if (!confirm("Smazat " + model.BatchNumber + "?")) {
                return;
            }

            app.batchesOverview.vm.deleteBatch(model.BatchId, function () {
                self.refreshBatchView(1);
            });
        };

        self.deleteProductionStep = function(stepModel) {
            if (!confirm("Smazat výrobní krok?")) {
                return;
            }

            app.batchesOverview.vm.deleteProductionStep(stepModel.StepId, function () {
                self.refreshBatchView(1);
            });
        };

        self.resolveStep = function(stepModel) {
            app.urlBus.set("fillstep", { "batchId": stepModel.BatchId, "stepId": stepModel.MaterialStepId });
        };
        
        updateView();
    });
</script>

<link href="/UI/Controls/Inventory/BatchesOverview/BatchList.css" rel="stylesheet" />