<div id="batchSearchPanel">
    <div class="batchesSearchSearchPanel">
        <div class="srchSegment text">
            <label>Číslo šarže</label>
            <input lt-name="tbBatchNumber" />
        </div>
        <div class="srchSegment text">
            <label>Číslo objednávky</label>
            <input lt-name="tbOrderNumber" />
        </div>
        <div class="srchSegment material">
            <label>Materiál</label>
            <div class="autocomplete" lt-name="materialAutocompleteContainer">
                <input lt-name="tbMaterial" />
            </div>
        </div>

        <div class="srchSegment fromto">
            <div class="srchSegment date">
                <label>Vytvořeno Od</label>
                <input lt-name="tbFrom" type="date" />
            </div>
            <div class="srchSegment date">
                <label>Vytvořeno Do</label>
                <input lt-name="tbTo" type="date" />
            </div>
        </div>

        <div class="srchSegment btstatus">
            <div class="srchCheck">
                <label>Zamčené</label>
                <input lt-name="cbLocked" type="checkbox" checked="checked" />
            </div>
            <div class="srchCheck">
                <label>Odemčné</label>
                <input lt-name="cbUnlocked" type="checkbox" checked="checked" />
            </div>
            <div class="srchCheck">
                <label>Uzavřené</label>
                <input lt-name="cbClosed" type="checkbox" checked="checked" />
            </div>
            <div class="srchCheck">
                <label>Otevřené</label>
                <input lt-name="cbOpen" type="checkbox" checked="checked" />
            </div>
        </div>
        <div class="srchSubmit">
            <button event-bind="click:doSearch"></button>
        </div>
    </div>

    <div lt-name="resultsPlaceholder"></div>
</div>

<!-- {"PageNumber":0,"MaterialId":null,"InventoryTypeId":null,"OrderNumber":null,"BatchNumberQuery":null,"From":null,"To":null,"ClosedBatches":null,"LockedBatches":null -->
<script>
    lt.element("batchSearchPanel").attach(function (tbBatchNumber, tbOrderNumber, tbFrom, tbTo, cbLocked, cbUnlocked, cbClosed, cbOpen, materialAutocompleteContainer, tbMaterial, resultsPlaceholder) {

        var self = this;

        lt.replaceBy(resultsPlaceholder, "/UI/Controls/Inventory/BatchesOverview/BatchList.html", function(lst) {
            self.list = lst;
            
            app.ui.autosuggest(materialAutocompleteContainer, app.warehouseActions.vm.searchMaterialNames);

            app.urlBus.watch("findBatches",
                function (qry) {
                    tbMaterial.value = qry.materialName;

                    var invokeSearch = function() {
                        if ((!self.list) || (!self.list.setQuery) || (!app) || (!app.batchesOverview) || (!app.batchesOverview.vm)) 
                        {
                            setTimeout(invokeSearch, 100);
                            return;
                        }
                        self.doSearch();
                    };

                    invokeSearch();
                   
            });
        });
        
        var emptyToNull = function (input) {
            if (input.value === null || input.value === undefined) {
                return null;
            }

            var value = input.value.trim();
            if (value.length === 0) {
                return null;
            }

            return value;
        };

        var trufanu = function (truecb, falsecb) {
            if (truecb.checked && falsecb.checked) {
                return null;
            }

            return truecb.checked;
        };
        
        this.doSearch = function() {
            
            var q = {};

            q.OrderNumber = emptyToNull(tbOrderNumber);
            q.BatchNumberQuery = emptyToNull(tbBatchNumber);
            q.From = emptyToNull(tbFrom);
            q.To = emptyToNull(tbTo);
            q.ClosedBatches = trufanu(cbClosed, cbOpen);
            q.LockedBatches = trufanu(cbLocked, cbUnlocked);

            var materialName = emptyToNull(tbMaterial);
            if (materialName != null) {
                app.materialHelper.waitMaterialInfoByName(materialName, function(matInfo) {
                    if (matInfo != null) {
                        q.MaterialId = matInfo.MaterialId;
                    }
                    self.list.setQuery(q);
                });
            } else {
                self.list.setQuery(q);
            }
        };
    });
</script>